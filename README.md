<!-- confluence-page-id: 27979350165 -->
# vulnerability-scanning


## Goal

The purpose of this project is to avoid manually monitoring the security dashboards in the PATCh gitlab repositories. 
It is a requirement that any HIGH or CRITICAL vulnerabilities found by security scanners (i.e. SAST) are resolved, this project allows the team to be alerted via pagerduty when one of those vulnerabilities occurs instead of having to check for them manually. Passive instead of Active maintenance.

## How it works

What's in the code:

- A graphql query is made to the gitlab API to retrieve all vulnerabilities for the given repository path. 
- After decoding the findings, we check for the words 'CRITICAL' or 'HIGH'. If they are found, it means that repo has a vulnerability that needs investigating.
- A REST call is made to the pagerduty API in order to trigger an alert on the repo that contains that vulnerability. The title of the alert will contain the name of the repo in question
- Repeat until all repositories have been queried. The list of repositories is stored in the parameter store key '/gitlab-repos'

## How it Runs

An eventbridge scheduler is configured to run every 10 days. It invokes the lambda function 'vulnerability-scanning' which will then begin executing the python code. 

## Lambda Layer

AWS lambdas do not have the 'requests' import built in. Therefore, it was needed to build a lambda layer to lay underneath the lambda function so it could import that package. The details on how to create and use a lambda layer can be found in confluence: [How-To-Create-A-Lambda-Layer](https://ciorg.atlassian.net/wiki/spaces/PAC/pages/27971059776/How+to+Create+a+Lambda+Layer)

## Infrastructure

The only resources needed for building this were:

- AWS lambda function
- AWS lambda layer
- AWS IAM role
- AWS Eventbridge schedule
- AWS Parameter Store key
- Gitlab access token
- Pagerduty access token

All AWS resources are created in us-east-2 region of the nonprod account using terraform.
